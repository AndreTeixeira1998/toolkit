#! /usr/bin/env bash

set -euo pipefail

SPACES_PER_INDENT=4

WARNINGS_FILE="$(mktemp)"

function add_warning() {
  echo "$@" >> "$WARNINGS_FILE"
}

function indent_to_level() {
  levels="$1"
  number_of_spaces=$(( levels * SPACES_PER_INDENT ))
  spaces="$(printf %${number_of_spaces}s)"
  echo -n "${spaces}"
}

function print_section_separator() {
  echo "== $* =="
}

function print_point() {
  level="0"
  if [[ "${1:-null}" =~ [0-9]{1} ]]; then
    level="$1"
    shift
  fi
  # shellcheck disable=SC2086
  echo "$(indent_to_level $level)- $*"
}

function check_host_information() {
  print_point 0 "Host Information"

  # Linux or not?
  if [[ $(uname -a) =~ .*Linux.* ]]; then
    print_point 1 "Linux"
  else
    print_point 1 "Not Linux !"
    add_warning "This system seems to not be Linux"
  fi

  # LSB Information (particular distribution of Linux, and version)
  if [[ -n $(command -v lsb_release) ]]; then
    print_point 1 "Output of 'lsb_release -a':"
    lsb_release -a 2>&1 | while read -r _line; do
      echo "$(indent_to_level 3)$_line"
    done
  else
    print_point 1 "lsb_release not found !"
  fi
}


function check_dependencies() {

  function get_version() {
    binary_name="$1"
    if [[ "bash" == "$binary_name" ]]; then
      bash -c 'echo $BASH_VERSION'
    elif [[ "perl" == "$binary_name" ]]; then
      perl -e 'print $];'
    else
      $binary_name --version | head -n 1
    fi
  }

  function check_for_binary() {
    binary_name="$1"
    print_point 1 "$binary_name"
    if [[ -n $(command -v "$binary_name") ]]; then
      print_point 2 "status: present"
      version=$(get_version "$binary_name")
      print_point 2 "version info: $version"
    else
      print_point 2 "status: MISSING !"
      add_warning "$binary_name not found"
    fi
  }

  print_point 0 "Dependencies"
  declare -a binaries=(
    bash
    docker
    docker-compose
    some-fake-program
    perl
    awk
  )

  for binary in "${binaries[@]}"; do
    check_for_binary "$binary"
  done
}

function check_docker_daemon() {
  print_point 0 "Docker Daemon"
  if docker ps &>/dev/null;  then
    print_point 1 "status: up"
  else
    print_point 1 "status: DOWN !"
    add_warning "Docker daemon is not running"
  fi
}

function print_warnings() {
  if [[ -n $(head -n 1 "$WARNINGS_FILE") ]]; then
    print_section_separator "Warnings"
    while read -r _line; do
      echo "! $_line"
    done < "$WARNINGS_FILE"
  fi
}

function check_config_files() {
  print_section_separator "Configuration"

  config_files=(
    "config/overleaf.rc"
    "config/variables.env"
    "config/docker-compose.base.yml"
    "config/docker-compose.mongo.yml"
    "config/docker-compose.redis.yml"
    "config/docker-compose.sibling-containers.yml"
  )
  for config_file in "${config_files[@]}"
  do
    print_point 1 "$config_file"
    if [[ ! -f "$config_file" ]]; then
      print_point 2 "status: MISSING !"
      add_warning "configuration file $config_file not found"
    else
      print_point 2 "status: present"
      if [[ "$config_file" == "config/overleaf.rc" ]]; then
        print_point 2 "values:"
        # Load vars from the rc file, prefixed with 'RC_ '
        # shellcheck disable=SC1090
        source <(
            grep -v '^#' "$config_file" |     # remove lines starting with '#'
                grep . |                  # remove blank lines
                grep -E '^[A-Z_]+=' |     # filter down to variable assignments
                awk '{print "RC_" $0}'    # prefix with 'RC_'
        )
        if [[ "${RC_IMAGE:-null}" != "null" ]]; then
          print_point 3 "IMAGE: $RC_IMAGE"
        else
          print_point 2 "IMAGE: MISSING !"
          add_warning "rc file, IMAGE not set"
        fi
        if [[ "${RC_SHARELATEX_DATA_PATH:-null}" != "null" ]]; then
          print_point 3 "SHARELATEX_DATA_PATH: $RC_SHARELATEX_DATA_PATH"
        else
          print_point 2 "SHARELATEX_DATA_PATH: MISSING !"
          add_warning "rc file, SHARELATEX_DATA_PATH not set"
        fi
      fi
    fi
  done
}

function cleanup() {
  rm "$WARNINGS_FILE"
}

function __main__() {
  print_section_separator "Overleaf Doctor"
  check_host_information
  check_dependencies
  check_docker_daemon
  check_config_files
  print_warnings
  print_section_separator "End"
  cleanup
}

__main__ "$@"
